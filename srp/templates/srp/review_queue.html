{% extends "base.html" %}
{% load humanize %}

{% block content %}
<h2>SRP Review Queue</h2>

<form method="get" class="mb-3">
  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:end;">
    <div>
      <label>Status</label><br/>
      <select name="status">
        <option value="ALL" {% if status == "ALL" %}selected{% endif %}>All</option>
        <option value="PENDING" {% if status == "PENDING" %}selected{% endif %}>Pending</option>
        <option value="APPROVED" {% if status == "APPROVED" %}selected{% endif %}>Approved</option>
        <option value="DENIED" {% if status == "DENIED" %}selected{% endif %}>Denied</option>
        <option value="PAID" {% if status == "PAID" %}selected{% endif %}>Paid</option>
      </select>
    </div>

    <div>
      <label>Category</label><br/>
      <select name="category">
        <option value="" {% if not category %}selected{% endif %}>All</option>
        <option value="STRATEGIC" {% if category == "STRATEGIC" %}selected{% endif %}>Strategic</option>
        <option value="PEACETIME" {% if category == "PEACETIME" %}selected{% endif %}>Peacetime</option>
        <option value="SHITSTACK" {% if category == "SHITSTACK" %}selected{% endif %}>Shitstack</option>
        <option value="TNT_SPECIAL" {% if category == "TNT_SPECIAL" %}selected{% endif %}>TNT Special</option>
      </select>
    </div>

    <div>
      <label>Search</label><br/>
      <input type="text" name="q" value="{{ q }}" placeholder="pilot, ship, system, link" />
    </div>

    <div>
      <button type="submit" class="btn btn-primary">Filter</button>
    </div>
  </div>
</form>

{% if claims %}
  <div class="table-responsive">
    <table class="table table-dark table-striped table-hover align-middle">
      <thead>
        <tr>
          <th>Submitted</th>
          <th>Submitter</th>
          <th>
            Victim
            <div class="text-secondary small fst-italic">(zKill)</div>
          </th>

          <th>
            Ship
            <div class="text-secondary small fst-italic">(fitting)</div>
          </th>

          <th>
            Category
            <div class="text-secondary small fst-italic">(broadcast)</div>
          </th>
          <th style="width:120px;">System</th>
          <th class="text-end">Payout</th>
          <th style="width:160px;">Claim Status</th>
          <th style="width:50px;">Fitting</th>
          <th style="width:70px;">Flags</th>
          <th style="width:340px;">Actions</th>
        </tr>
      </thead>

      <tbody>
        {% for c in claims %}
        <tr>
          <td>{{ c.submitted_at|date:"Y-m-d H:i" }}</td>
          <td>{{ c.submitter.username }}</td>
          <td class="text-nowrap">
            {% if c.victim_character_name %}
              {% if c.killmail_id %}
                <a href="https://zkillboard.com/kill/{{ c.killmail_id }}/"
                  target="_blank" rel="noopener"
                  class="link-light text-decoration-none">
                  {{ c.victim_character_name }}
                </a>
              {% else %}
                {{ c.victim_character_name }}
              {% endif %}
            {% else %}
              <span class="text-secondary">—</span>
            {% endif %}
          </td>

          <td>
            {% if c.ship or c.ship_name %}
              <!-- Hidden popover content (slot-grouped) -->
              <div id="fit-{{ c.id }}" class="d-none">
                {% if c.fitting_item_count == 0 %}
                  <div class="text-secondary small">
                    No item data stored for this claim yet (ESI pull may have failed).
                  </div>
                  <div class="text-secondary small mt-2">Open claim for full details.</div>
                {% else %}
                  {% if c.fitting_groups_preview %}
                    {% for group_name, lines in c.fitting_groups_preview %}
                      <div class="mb-2">
                        <strong class="small">{{ group_name }}</strong>
                        <div class="small mt-1">
                          {% for line in lines|slice:":8" %}
                            <div>{{ line }}</div>
                          {% endfor %}
                          {% if lines|length > 8 %}
                            <div class="text-secondary">…and {{ lines|length|add:"-8" }} more</div>
                          {% endif %}
                        </div>
                      </div>
                    {% endfor %}
                    <div class="text-secondary small mt-2">Open claim for full fit.</div>
                  {% else %}
                    <div class="text-secondary small">
                      Items exist but preview couldn’t be built yet (type cache warming).
                    </div>
                    <div class="text-secondary small mt-2">Open claim for full details.</div>
                  {% endif %}
                {% endif %}
              </div>

              <!-- Click target -->
              <a href="javascript:void(0)"
                class="link-light text-decoration-none"
                data-bs-toggle="popover"
                data-bs-custom-class="popover-dark"
                data-bs-title="Fitting preview"
                data-fit-target="fit-{{ c.id }}">
                {% if c.ship %}{{ c.ship.ship_name }}{% else %}{{ c.ship_name }}{% endif %}
              </a>
            {% else %}
              <span class="text-secondary">—</span>
            {% endif %}
          </td>

          <td class="text-nowrap">
            <a href="javascript:void(0)"
              class="link-light text-decoration-none"
              data-bs-toggle="popover"
              data-bs-custom-class="popover-dark"
              data-bs-title="Broadcast / Op Post"
              data-bs-content="
                <div class='small' style='white-space:pre-wrap'>
                  {% if c.broadcast_text %}{{ c.broadcast_text|escape }}{% else %}<span class='text-secondary'>—</span>{% endif %}
                </div>
              ">
              {{ c.get_category_display }}
            </a>
          </td>

          <td>{{ c.system|default:"-" }}</td>

          <td class="text-end">
            {% if c.payout_amount is not None %}
              {{ c.payout_amount|floatformat:0|intcomma }}
            {% else %}
              —
            {% endif %}
          </td>

          <!-- CLAIM STATUS (collapsed) -->
          <td>
            <div>
              <strong>{{ c.get_status_display }}</strong>
              {% if c.reviewer %}
                <span class="text-secondary small">by {{ c.reviewer.username }}</span>
              {% endif %}
            </div>

            <div class="text-secondary small">
              {% if c.status == "PAID" %}
                {% if c.paid_at %}
                  Paid {{ c.paid_at|date:"Y-m-d H:i" }}
                {% elif c.processed_at %}
                  Paid {{ c.processed_at|date:"Y-m-d H:i" }}
                {% else %}
                  Paid {{ c.submitted_at|date:"Y-m-d H:i" }}
                {% endif %}
              {% elif c.status == "APPROVED" or c.status == "DENIED" %}
                {% if c.processed_at %}
                  {{ c.processed_at|date:"Y-m-d H:i" }}
                {% else %}
                  {{ c.submitted_at|date:"Y-m-d H:i" }}
                {% endif %}
              {% else %}
                {{ c.submitted_at|date:"Y-m-d H:i" }}
              {% endif %}
            </div>
            {% if c.edited_at %}
              <div class="text-secondary small">
                Edited {{ c.edited_at|date:"Y-m-d H:i" }}
              </div>
            {% endif %}

          </td>

          <!-- Fit flags (cached; zero recompute) -->
          <td>
            <div class="d-flex flex-column gap-1">
              {% if c.fitcheck_status == "FIT_OK" %}
                <span class="badge text-bg-success">OK</span>
              {% elif c.fitcheck_status == "FIT_CLOSE" %}
                <span class="badge text-bg-warning">Close</span>
              {% elif c.fitcheck_status == "FIT_MISMATCH" %}
                <span class="badge text-bg-danger">Mismatch</span>
              {% elif c.fitcheck_status == "NO_DOCTRINE_FIT" %}
                <span class="badge text-bg-secondary">No Fit</span>
              {% else %}
                <span class="badge text-bg-secondary">—</span>
              {% endif %}

              {% if c.no_rigs_flag %}
                <span class="badge text-bg-danger">No Rigs</span>
              {% endif %}
            </div>
          </td>


          <!-- FLAGS COLUMN -->
          <td>
            <div class="d-flex flex-column gap-1">
              {% if c.flag_blue %}
                <span class="badge text-bg-warning">Blue</span>
              {% endif %}
              {% if c.flag_npc %}
                <span class="badge text-bg-warning">NPC</span>
              {% endif %}
              {% if c.flag_corp_mismatch %}
                <span class="badge text-bg-warning">Corp</span>
              {% endif %}
              {% if c.flag_non_tnt %}
                <span class="badge text-bg-danger">Non-TNT</span>
              {% endif %}
              {% if not c.flag_blue and not c.flag_npc and not c.flag_corp_mismatch and not c.flag_non_tnt %}
                <span class="text-secondary small">—</span>
              {% endif %}
            </div>
          </td>

          <!-- ACTIONS COLUMN -->
          <td>
            <form method="post" class="d-flex flex-column gap-2" style="width: 280px;">
              {% csrf_token %}

              <!-- All buttons on ONE row -->
              <div class="d-flex flex-wrap gap-2">
                <a class="btn btn-info btn-sm text-dark"
                  href="{% url 'srp:claim_detail' c.id %}">
                  View
                </a>

                <button class="btn btn-success btn-sm"
                        formaction="{% url 'srp:approve_claim' c.id %}">
                  {% if c.status == "APPROVED" %}Unapprove{% else %}Approve{% endif %}
                </button>

                <button class="btn btn-danger btn-sm"
                        formaction="{% url 'srp:deny_claim' c.id %}">
                  {% if c.status == "DENIED" %}Undeny{% else %}Deny{% endif %}
                </button>

                <button class="btn btn-secondary btn-sm"
                        formaction="{% url 'srp:pay_claim' c.id %}"
                        {% if c.status != "APPROVED" and c.status != "PAID" %}disabled{% endif %}>
                  {% if c.status == "PAID" %}Unpay{% else %}Mark Paid{% endif %}
                </button>
              </div>

              <!-- Note field BELOW the buttons -->
              <input type="text"
                    name="comment"
                    class="form-control form-control-sm"
                    placeholder="Reviewer note (optional)" />
            </form>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
{% else %}
  <p>No claims match your filters.</p>
{% endif %}

{% endblock %}

{% block extra_js %}
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const triggers = [].slice.call(document.querySelectorAll('[data-bs-toggle="popover"]'));
    triggers.forEach(function (el) {
      new bootstrap.Popover(el, {
        container: "body",
        html: true,
        sanitize: false,
        trigger: "click",
        placement: "auto",
        content: function () {
          const targetId = el.getAttribute("data-fit-target");
          if (targetId) {
            const node = document.getElementById(targetId);
            return node ? node.innerHTML : "<div class='text-secondary small'>No fitting preview.</div>";
          }
          return el.getAttribute("data-bs-content") || "";
        }
      });
    });
  });
</script>

{% endblock %}
