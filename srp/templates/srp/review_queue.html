{% extends "base.html" %}
{% block content %}
{% load humanize %}

<h2>SRP Review Queue</h2>

<form method="get" class="mb-3">
  <div style="display:flex; gap:12px; flex-wrap:wrap; align-items:end;">
    <div>
      <label>Status</label><br/>
      <select name="status">
        <option value="ALL" {% if status == "ALL" %}selected{% endif %}>All</option>
        <option value="PENDING" {% if status == "PENDING" %}selected{% endif %}>Pending</option>
        <option value="APPROVED" {% if status == "APPROVED" %}selected{% endif %}>Approved</option>
        <option value="DENIED" {% if status == "DENIED" %}selected{% endif %}>Denied</option>
        <option value="PAID" {% if status == "PAID" %}selected{% endif %}>Paid</option>
      </select>
    </div>

    <div>
      <label>Category</label><br/>
      <select name="category">
        <option value="" {% if not category %}selected{% endif %}>All</option>
        <option value="STRATEGIC" {% if category == "STRATEGIC" %}selected{% endif %}>Strategic</option>
        <option value="PEACETIME" {% if category == "PEACETIME" %}selected{% endif %}>Peacetime</option>
        <option value="SHITSTACK" {% if category == "SHITSTACK" %}selected{% endif %}>Shitstack</option>
        <option value="TNT_SPECIAL" {% if category == "TNT_SPECIAL" %}selected{% endif %}>TNT Special</option>
      </select>
    </div>

    <div>
      <label>Search</label><br/>
      <input type="text" name="q" value="{{ q }}" placeholder="pilot, ship, system, link" />
    </div>

    <div>
      <button type="submit" class="btn btn-primary">Filter</button>
    </div>
  </div>
</form>

{% if claims %}
  <table class="table table-striped table-hover">
    <thead>
      <tr>
        <th>ID</th>
        <th>Submitted</th>
        <th>Submitter</th>
        <th>Victim</th>
        <th>Ship</th>
        <th>Category</th>
        <th>System</th>
        <th>Payout</th>
        <th>Status</th>
        <th>Reviewer</th>
        <th>Processed</th>
        <th>Paid</th>
        <th style="width:320px;">Actions</th>
      </tr>
    </thead>
    <tbody>
      {% for c in claims %}
      <tr>
        <td>#{{ c.id }}</td>
        <td>{{ c.submitted_at|date:"Y-m-d H:i" }}</td>
        <td>{{ c.submitter.username }}</td>
        <td>{{ c.victim_character_name|default:"—" }}</td>

        <td>
          {% if c.killmail_id %}
            <a
              href="https://zkillboard.com/kill/{{ c.killmail_id }}/"
              target="_blank"
              rel="noopener"
              class="link-info"
            >
              {% if c.ship %}
                {{ c.ship.ship_name }}
              {% elif c.ship_name %}
                {{ c.ship_name }}
              {% else %}
                Unknown Ship
              {% endif %}
            </a>
          {% else %}
            {% if c.ship %}
              {{ c.ship.ship_name }}
            {% elif c.ship_name %}
              {{ c.ship_name }}
            {% else %}
              —
            {% endif %}
          {% endif %}
        </td>

        <td>{{ c.get_category_display }}</td>

        <td>
          {% if c.solar_system_name %}
            {{ c.solar_system_name }}
          {% else %}
            {{ c.system|default:"-" }}
          {% endif %}
        </td>

        <td>{{ c.payout_amount|floatformat:0|intcomma }}</td>

        <td>{{ c.get_status_display }}</td>

        <td>
          {% if c.reviewer %}
            {{ c.reviewer.username }}
          {% else %}
            —
          {% endif %}
        </td>

        <td>
          {% if c.processed_at %}
            {{ c.processed_at|date:"Y-m-d H:i" }}
          {% else %}
            —
          {% endif %}
        </td>

        <td>
          {% if c.paid_at %}
            {{ c.paid_at|date:"Y-m-d H:i" }}
          {% else %}
            —
          {% endif %}
        </td>

        <td>
          <form method="post" class="d-flex flex-column gap-2" style="min-width: 320px;">
            {% csrf_token %}

            <!-- Row of actions -->
            <div class="d-flex flex-wrap gap-2">
              <a class="btn btn-info btn-sm" href="{% url 'srp:claim_detail' c.id %}">View</a>

              <button
                class="btn btn-success btn-sm"
                formaction="{% url 'srp:approve_claim' c.id %}"
                {% if c.status != "PENDING" %}disabled{% endif %}
              >
                Approve
              </button>

              <button
                class="btn btn-danger btn-sm"
                formaction="{% url 'srp:deny_claim' c.id %}"
                {% if c.status != "PENDING" %}disabled{% endif %}
              >
                Deny
              </button>

              <button
                class="btn btn-secondary btn-sm"
                formaction="{% url 'srp:pay_claim' c.id %}"
                {% if c.status != "APPROVED" %}disabled{% endif %}
              >
                Mark Paid
              </button>
            </div>

            <!-- Note field below -->
            <textarea
              name="comment"
              class="form-control form-control-sm"
              rows="2"
              placeholder="Reviewer note (optional)"
            ></textarea>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
{% else %}
  <p>No claims match your filters.</p>
{% endif %}

{% endblock %}
